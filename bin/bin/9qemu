#!/usr/bin/env bash

# Variables
VM_DIR="$HOME/VM"
QCOW_IMG="$VM_DIR/9front.qcow2.img"
ISO_DIR="$VM_DIR/ISO"
ISO_FILE="$ISO_DIR/9front.386.iso"
IMAGE_SIZE="30G"
VM_MEMORY="1024"
MAC_ADDR="52:54:00:00:EE:03"

# Functions
die() {
    echo "Error: $1" >&2
    exit 1
}

create_qcow_image() {
    echo "Creating QCOW2 image..."
    mkdir -p "$VM_DIR" || die "Failed to create VM directory."
    qemu-img create -f qcow2 "$QCOW_IMG" "$IMAGE_SIZE" \
        || die "Failed to create QCOW2 image."
    echo "QCOW2 image created at $QCOW_IMG."
}

run_vm() {
    echo "Running the 9front VM..."
    [[ -f "$ISO_FILE" ]] || die "ISO file not found at $ISO_FILE. Please download it."
    [[ -f "$QCOW_IMG" ]] || die "QCOW2 image not found at $QCOW_IMG. Please create it first."

    qemu-system-x86_64 -cpu host -enable-kvm -m "$VM_MEMORY" \
        -net nic,model=virtio,macaddr="$MAC_ADDR" -net user \
        -device virtio-scsi-pci,id=scsi \
        -drive if=none,id=vd0,file="$QCOW_IMG" \
        -device scsi-hd,drive=vd0 \
        -drive if=none,id=vd1,file="$ISO_FILE" \
        -device scsi-cd,drive=vd1,bootindex=0 \
        || die "Failed to start the VM."
}

# Main
case "$1" in
    create)
        create_qcow_image
        ;;
    run)
        run_vm
        ;;
    *)
        echo "Usage: $0 {create|run}"
        echo "  create: Create a QCOW2 image for the VM."
        echo "  run: Run the 9front VM using QEMU."
        exit 1
        ;;
esac
